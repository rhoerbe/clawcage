- name: Create agent user
  ansible.builtin.user:
    name: "{{ agent_username }}"
    comment: "{{ agent_comment }}"
    shell: "{{ agent_shell }}"
    create_home: true
    state: present

- name: Create agent directories
  ansible.builtin.file:
    path: "/home/{{ agent_username }}/{{ item }}"
    state: directory
    owner: "{{ agent_username }}"
    group: "{{ agent_username }}"
    mode: "0700"
  loop: "{{ agent_directories }}"

- name: Create SSH CA directory
  ansible.builtin.file:
    path: "{{ agent_ssh_ca_dir }}"
    state: directory
    owner: "{{ agent_username }}"
    group: "{{ agent_username }}"
    mode: "0700"

- name: Generate agent SSH key
  ansible.builtin.command:
    cmd: ssh-keygen -t ed25519 -f /home/{{ agent_username }}/.ssh/id_ed25519 -C "{{ agent_username }}" -N ""
    creates: /home/{{ agent_username }}/.ssh/id_ed25519

- name: Set ownership on SSH key
  ansible.builtin.file:
    path: "/home/{{ agent_username }}/.ssh/{{ item }}"
    owner: "{{ agent_username }}"
    group: "{{ agent_username }}"
    mode: "0600"
  loop:
    - id_ed25519
    - id_ed25519.pub
  ignore_errors: "{{ ansible_check_mode }}"

- name: Generate SSH CA key
  ansible.builtin.command:
    cmd: ssh-keygen -t ed25519 -f {{ agent_ssh_ca_dir }}/ca_key -C "{{ agent_username }}-ca" -N ""
    creates: "{{ agent_ssh_ca_dir }}/ca_key"

- name: Set ownership on CA key
  ansible.builtin.file:
    path: "{{ agent_ssh_ca_dir }}/{{ item }}"
    owner: "{{ agent_username }}"
    group: "{{ agent_username }}"
    mode: "0600"
  loop:
    - ca_key
    - ca_key.pub
  ignore_errors: "{{ ansible_check_mode }}"

- name: Check if certificate exists
  ansible.builtin.stat:
    path: /home/{{ agent_username }}/.ssh/id_ed25519-cert.pub
  register: cert_stat

- name: Sign agent key with CA (valid 1 day)
  ansible.builtin.command:
    cmd: ssh-keygen -s {{ agent_ssh_ca_dir }}/ca_key -I "{{ agent_username }}" -n {{ ha_user }} -V +1d /home/{{ agent_username }}/.ssh/id_ed25519.pub
  when: not cert_stat.stat.exists or (ansible_date_time.epoch | int - cert_stat.stat.mtime | default(0) | int > 79200)
  ignore_errors: "{{ ansible_check_mode }}"

- name: Set ownership on certificate
  ansible.builtin.file:
    path: /home/{{ agent_username }}/.ssh/id_ed25519-cert.pub
    owner: "{{ agent_username }}"
    group: "{{ agent_username }}"
    mode: "0644"
  ignore_errors: "{{ ansible_check_mode }}"

- name: Deploy SSH config for agent
  ansible.builtin.copy:
    dest: /home/{{ agent_username }}/.ssh/config
    content: |
      Host ha
          HostName {{ ha_host }}
          User {{ ha_user }}
          IdentityFile ~/.ssh/id_ed25519
          CertificateFile ~/.ssh/id_ed25519-cert.pub
          StrictHostKeyChecking accept-new
    owner: "{{ agent_username }}"
    group: "{{ agent_username }}"
    mode: "0600"

- name: Create certificate renewal cron job
  ansible.builtin.cron:
    name: "Renew {{ agent_username }} SSH certificate"
    minute: "0"
    hour: "4"
    job: "ssh-keygen -s {{ agent_ssh_ca_dir }}/ca_key -I {{ agent_username }} -n {{ ha_user }} -V +1d /home/{{ agent_username }}/.ssh/id_ed25519.pub"
    user: "{{ agent_username }}"

- name: Enable lingering for agent user
  ansible.builtin.command:
    cmd: loginctl enable-linger {{ agent_username }}
  register: linger_result
  changed_when: linger_result.rc == 0
  failed_when: false

- name: Copy container files to agent home
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "/home/{{ agent_username }}/{{ item.dest }}"
    owner: "{{ agent_username }}"
    group: "{{ agent_username }}"
    mode: "{{ item.mode }}"
  loop:
    - { src: "{{ playbook_dir }}/../../mcp-config.json", dest: ".claude/claude_code_config.json", mode: "0644" }
    - { src: "{{ playbook_dir }}/../../build.sh", dest: "build.sh", mode: "0755" }
    - { src: "{{ playbook_dir }}/../../start_container.sh", dest: "start_container.sh", mode: "0755" }
    - { src: "{{ playbook_dir }}/../../Dockerfile", dest: "Dockerfile", mode: "0644" }
